using ESRI.ArcGIS.SystemUI;
using ESRI.ArcGIS.esriSystem;
using ESRI.ArcGIS.Display;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.IO;
using ESRI.ArcGIS.Carto;
using Proyecto;
using System.Windows.Forms;
using ESRI.ArcGIS.Geometry;
using ESRI.ArcGIS.Geodatabase;
using System.Runtime.InteropServices;
using ESRI.ArcGIS.ArcMapUI;
using ESRI.ArcGIS.Editor;
<<<<<<< HEAD
using ESRI.ArcGIS.Geoprocessor;
=======
using ESRI.ArcGIS.Catalog;
>>>>>>> 7960da603faa1ca0e240cfdb15fc1cf0327c99fa



class Zonificacion
{

    public SSA ssa; 

    private int columnas;
    public int Columnas
    {
        get { return columnas; }
        set { columnas = value; }
    }

    private int filas;
    public int Filas
    {
        get { return filas; }
        set { filas = value; }
    }

    public Coordenada coordenadaInicial;

    private int tamanoCelda;
    public int TamanoCelda
    {
        get { return tamanoCelda; }
        set { tamanoCelda = value; }
    }

    private List<Variable> variables;
    internal List<Variable> Variables
    {
        get { return variables; }
        set { variables = value; }
    }
    
    private List<PuntoZonificacion> puntosZonificacion;
    internal List<PuntoZonificacion> PuntosZonificacion
    {
        get { return puntosZonificacion; }
        set { puntosZonificacion = value; }
    }

    private ESRI.ArcGIS.Geometry.IPoint puntoOrigen;

    public ESRI.ArcGIS.Geometry.IPoint PuntoOrigen
    {
        get { return puntoOrigen; }
        set { puntoOrigen = value; }
    }
    private ESRI.ArcGIS.Geometry.IPoint puntoOpuesto;

    public ESRI.ArcGIS.Geometry.IPoint PuntoOpuesto
    {
        get { return puntoOpuesto; }
        set { puntoOpuesto = value; }
    }

    //Dada la coordenada inicial y el tamamio de la celda, calculamos la siguiente coordenada en base al x e y actual (desplazamiento en celdas
    //desde la posicion (x,y)=(0,0) hasta la posicion actual x,y pasada por parametro)
    public Coordenada calcularCoordenada(Coordenada coordenadaInicial, int TamanoCelda, int x, int y)
    {
        Coordenada coordenada = new Coordenada();
        coordenada.X = coordenadaInicial.X + TamanoCelda * x;
        coordenada.Y = coordenadaInicial.Y - TamanoCelda * y;
        return coordenada;

    }



    public Zonificacion(String rutaEntrada, List<int> variables_seleccion)
    {
        //Obtengo el archivo
        StreamReader objReader = new StreamReader(rutaEntrada);
        //Incicializo la variable donde voy a guardar cada linea que leo y la variable donde voy a guardar en memoria el contenido del archivo
        string sLine = "";
        int Rows = 0;
        int Cols = 0;
        double xinicial = 0;
        double yinicial = 0;
        int cellSize = 0;
        int cant_variables = 0;
        string string_rows = "Rows: ";
        string string_cols = "Cols: ";
        string string_Xinicial = "CoordX: ";
        string string_Yinicial = "CoordY: ";
        string string_CellSize = "CellSize: ";
        string string_cant_variables = "VarQty:";
        coordenadaInicial = new Coordenada();
        string NAN = "NaN";

        string comienzo_datos = "[Cells]";

        //Leo la linea actual del archivo
        sLine = objReader.ReadLine();

        //leo hasta la etiqueta [Cells] y saco los valores de rows, cols y cant_variables 
        while (sLine != null)
        {
            if (((sLine != "") && sLine.Substring(0, string_rows.Length) == string_rows))
            {
                Rows = Int32.Parse(sLine.Substring(string_rows.Length, sLine.Length - string_rows.Length));
                this.Filas = Rows;
            } 
            else if (((sLine != "") && sLine.Substring(0, string_cols.Length) == string_cols))
            {
                Cols = Int32.Parse(sLine.Substring(string_cols.Length, sLine.Length - string_cols.Length));
                this.Columnas = Cols;
            }
            else if (((sLine != "") && (sLine.Length >= string_Xinicial.Length) && sLine.Substring(0, string_Xinicial.Length) == string_Xinicial))
            {
                xinicial = Double.Parse(sLine.Substring(string_Xinicial.Length, sLine.Length - string_Xinicial.Length));
                this.coordenadaInicial.X = xinicial; 
            }
            else if (((sLine != "") && (sLine.Length >= string_Yinicial.Length)  && sLine.Substring(0, string_Yinicial.Length) == string_Yinicial))
            {
                yinicial = Double.Parse(sLine.Substring(string_Yinicial.Length, sLine.Length - string_Yinicial.Length));
                this.coordenadaInicial.Y = yinicial;
            }
            else if (((sLine != "") && (sLine.Length >= string_CellSize.Length)  && sLine.Substring(0, string_CellSize.Length) == string_CellSize))
            {
                cellSize = Int32.Parse(sLine.Substring(string_CellSize.Length, sLine.Length - string_CellSize.Length));
                this.TamanoCelda = cellSize;
            }
            else if (((sLine != "") && (sLine.Length >= string_cant_variables.Length) && sLine.Substring(0, string_cant_variables.Length) == string_cant_variables))
            {
                cant_variables = Int32.Parse(sLine.Substring(string_cant_variables.Length, sLine.Length - string_cant_variables.Length));
                int i = 1;
                sLine = objReader.ReadLine();
                String nombreVariable = "";

                int p = 0;
                while (i <= cant_variables && sLine != "" && p < variables_seleccion.Count )
                {
                    if ((i-1) == variables_seleccion[p]) //es i-1 porque en el archivo ZF el i comienza en 1 y la seleccion de variable comienza en 0
                    {
                        String aux = "Var" + i + ": ";
                        if ((sLine.Substring(0, aux.Length) == aux))
                        {
                            nombreVariable = sLine.Substring(aux.Length, sLine.Length - aux.Length);
                            Variable variable = new Variable(nombreVariable);
                            this.agregarVariable(variable);
                        }
                        p++;
                    }
                    i++;
                    sLine = objReader.ReadLine();
                }
            }

            //Llegue a la etiqueta [Cells] entonces se que a continuacion empiezan los valores de los puntos muestreados
            if (((sLine != "") && (sLine.Substring(0, comienzo_datos.Length) == comienzo_datos)))
                break;

            sLine = objReader.ReadLine();
        }  //fin while de datos generales

        //se setea el puntoOrigen
        this.puntoOrigen = new ESRI.ArcGIS.Geometry.PointClass();
        this.puntoOrigen.X = xinicial;
        this.puntoOrigen.Y = yinicial - Rows * cellSize;

        //se setea el puntoOpuesto
        this.puntoOpuesto = new ESRI.ArcGIS.Geometry.PointClass();
        this.puntoOpuesto.X = xinicial + Cols * cellSize;
        this.puntoOpuesto.Y = yinicial;

        //comienza el proceso de los puntos de la zonificacion
        for (int iy = 1; iy <= this.Filas; iy++)
        {
            for (int ix = 1; ix <= this.Columnas; ix++)
            {
                sLine = objReader.ReadLine(); 
                
                PuntoZonificacion ptoZonificacion = new PuntoZonificacion();
                ptoZonificacion.Coordenada = calcularCoordenada(this.coordenadaInicial, this.TamanoCelda, ix-1, iy-1);
                ptoZonificacion.Variables = this.Variables;

                char[] coma = { ';' };
                string[] datos = null;
                datos = sLine.Split(coma);
                bool puntoUtil = true;

                for (int i = 0; i < variables_seleccion.Count; i++){
                    if (datos[variables_seleccion[i]] == NAN)
                    {
                        puntoUtil = false;
                        break;
                    }
                    else
                        ptoZonificacion.agregarDato(ptoZonificacion.Variables[i].Nombre, float.Parse(datos[variables_seleccion[i]]));                    
                }
                ptoZonificacion.Util = puntoUtil;
                //agrego el punto solo si tiene datos
                if (ptoZonificacion.Util)
                    this.agregarPuntoZonificacion(ptoZonificacion);
            }
        }

        //cierro el archivo
        objReader.Close();
    }

<<<<<<< HEAD
        this.calcularVariabilidad();

        IMap map = ArcMap.Document.FocusMap;
        String capaPuntosZonificacion = System.DateTime.Now.ToString("ddHHmmss");
        IFeatureClass capaClass =  this.crearNuevaCapa(map, capaPuntosZonificacion, puntosZonificacion);

        SSA ssa = new SSA();
        List<PuntoZonificacion> puntosMuestrear = ssa.SimulatedAnnealing2(puntosZonificacion);
       // this.crearNuevaCapa(map, "capaMuestreo", puntosMuestrear);

        String capaPuntosMuestreo = "m" + System.DateTime.Now.ToString("ddHHmmss");

        IFeatureClass vecinosClass = this.crearNuevaCapa(map, capaPuntosMuestreo, puntosMuestrear);

        String capaVecinos = "v" + System.DateTime.Now.ToString("ddHHmmss");

        Geoprocessor gp = new Geoprocessor();
        ESRI.ArcGIS.GeostatisticalAnalystTools.IDW vecinos = new ESRI.ArcGIS.GeostatisticalAnalystTools.IDW();
        vecinos.in_features = vecinosClass;
        vecinos.out_ga_layer = capaVecinos;
        vecinos.z_field = vecinosClass.FindField("Valor");
        
        gp.AddOutputsToMap = true;
        gp.Execute(vecinos, null);
        
        for (int i = 0; i < gp.MessageCount; i++)
            System.Diagnostics.Debug.WriteLine(gp.GetMessage(i));


        String capaVecinosOut = "vOut" + System.DateTime.Now.ToString("ddHHmmss");


        Geoprocessor gp2 = new Geoprocessor();
        ESRI.ArcGIS.GeostatisticalAnalystTools.GALayerToPoints estimacion = new ESRI.ArcGIS.GeostatisticalAnalystTools.GALayerToPoints();
        //estimacion.in_geostat_layer = vecinos.out_ga_layer;
        estimacion.in_locations = vecinosClass;
        estimacion.out_feature_class = capaVecinosOut;
        estimacion.z_field = "Valor";
        estimacion.in_geostat_layer = vecinos.out_ga_layer;
        
        

        //IEnumLayer enumlayers = map.get_Layers();

        ////se busca la capa de puntos
        //enumlayers.Reset();
        //ILayer layerPuntos = enumlayers.Next();
        //while ((layerPuntos != null) && (layerPuntos.Name != "nuevaCapavecinos2"))
        //{
        //    layerPuntos = enumlayers.Next();
        //}
        //IFeatureLayer ifeaturelayerPuntos = layerPuntos as FeatureLayer;
        //IFeatureClass featureclassPuntos = ifeaturelayerPuntos.FeatureClass;
        //if(layerPuntos != null)
        //    estimacion.in_geostat_layer = layerPuntos;

        //string sPath = System.IO.Path.GetDirectoryName (System.Reflection.Assembly.GetExecutingAssembly().Location);

        //estimacion.in_geostat_layer = "C:\\Users\\Martin\\Desktop\\Proyecto Grado\\New folder\\Datos\\Mapas\\Muestras\\nuevaCapavecinos2.lyr";

        //estimacion.in_geostat_layer = "C:\\nuevaCapavecinos2.lyr";

        //gp2.AddOutputsToMap = true;

        try
        {
            System.Diagnostics.Debug.WriteLine("Executing the try statement.");
            gp2.Execute(estimacion, null);
        }
        catch (NullReferenceException e)
        {
            System.Diagnostics.Debug.WriteLine("{0} Caught exception #1." + e);
        }
        catch
        {
            for (int i = 0; i < gp2.MessageCount; i++)
                System.Diagnostics.Debug.WriteLine(gp2.GetMessage(i));
            System.Diagnostics.Debug.WriteLine("Caught exception #2.");
        }
        finally
        {
            for (int i = 0; i < gp2.MessageCount; i++)
                System.Diagnostics.Debug.WriteLine(gp2.GetMessage(i));
            System.Diagnostics.Debug.WriteLine("Executing finally block.");
        }
       
    }

    

=======
    //Calcula la distancia entre dos puntos y devuelve la distancia en metros luego de redondear el resultado
    public int calcularDistancia(int i, int j)
    {
        double cuadX = (this.puntosZonificacion[i].Coordenada.X - this.puntosZonificacion[j].Coordenada.X) * (this.puntosZonificacion[i].Coordenada.X - this.puntosZonificacion[j].Coordenada.X);
        double cuadY = (this.puntosZonificacion[i].Coordenada.Y - this.puntosZonificacion[j].Coordenada.Y) * (this.puntosZonificacion[i].Coordenada.Y - this.puntosZonificacion[j].Coordenada.Y);
        double distancia = Math.Sqrt(cuadX + cuadY);
        return (int)Math.Round(distancia);

    }

>>>>>>> 7960da603faa1ca0e240cfdb15fc1cf0327c99fa

    public void calcularVariabilidad()
    {        
        for (int i = 0; i < this.Variables.Count; i++) { this.Variables[i].calcularMedia(this.puntosZonificacion); }                       
        for (int i = 0; i < this.puntosZonificacion.Count; i++) { this.puntosZonificacion[i].calcularVariabilidad(); }

        double cuadX = (this.puntosZonificacion[10].Coordenada.X - this.puntosZonificacion[2800].Coordenada.X) * (this.puntosZonificacion[10].Coordenada.X - this.puntosZonificacion[2800].Coordenada.X);
        double cuadY = (this.puntosZonificacion[10].Coordenada.Y - this.puntosZonificacion[2800].Coordenada.Y) * (this.puntosZonificacion[10].Coordenada.Y - this.puntosZonificacion[2800].Coordenada.Y);
        double distancia = Math.Sqrt(cuadX + cuadY);
        MessageBox.Show("distancia" + distancia.ToString());
    }

    public void agregarVariable(Variable variable)
    {
        if (this.variables == null)
            this.variables = new List<Variable>();

        this.variables.Add(variable);
    }

    public void agregarPuntoZonificacion(PuntoZonificacion punto)
    {
        if (this.puntosZonificacion == null)
            this.puntosZonificacion = new List<PuntoZonificacion>();

        this.puntosZonificacion.Add(punto);
    }

}
